# src/ai_prompts.py
from __future__ import annotations


BASE_TAROT_SYSTEM_PROMPT = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º.

üö® –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
2. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞, –∫—Ä–æ–º–µ –æ–±—â–µ—É–ø–æ—Ç—Ä–µ–±–∏–º—ã—Ö –∏–º—ë–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö.
3. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π JSON, YAML –∏ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö, –Ω–µ –æ—Ñ–æ—Ä–º–ª—è–π –æ—Ç–≤–µ—Ç –∫–∞–∫ –∫–æ–¥.
4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π HTML-—Ä–∞–∑–º–µ—Ç–∫—É (<b>, <i> –∏ —Ç.–ø.).
5. –ü–∏—à–∏ –∂–∏–≤—ã–º, —á–µ–ª–æ–≤–µ—á–Ω—ã–º —è–∑—ã–∫–æ–º, –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥, –æ–±—ä—è—Å–Ω—è—é—â–∏–π —Ä–∞—Å–∫–ª–∞–¥ –∫–ª–∏–µ–Ω—Ç—É.
6. –ò–∑–±–µ–≥–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π —Å–º–µ—Ä—Ç–∏, –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –∏ –¥—Ä—É–≥–∏—Ö –ø—É–≥–∞—é—â–∏—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤.
""".strip()


def build_profile_context(
    user_age: int | None = None,
    user_gender: str | None = None,
    user_name: str | None = None,
) -> str:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥–º–µ—à–∏–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–º–ø—Ç—ã.

    –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞, –Ω–∏ –ø–æ–ª–∞, –Ω–∏ –∏–º–µ–Ω–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É.
    """
    if user_age is None and not user_gender and not user_name:
        return ""

    # –ü–æ–ª ‚Üí —á–µ–ª–æ–≤–µ–∫ / –º—É–∂—á–∏–Ω–∞ / –∂–µ–Ω—â–∏–Ω–∞
    gender_label = "—á–µ–ª–æ–≤–µ–∫"
    if user_gender:
        gender_lower = user_gender.lower()
        if gender_lower == "male":
            gender_label = "–º—É–∂—á–∏–Ω–∞"
        elif gender_lower == "female":
            gender_label = "–∂–µ–Ω—â–∏–Ω–∞"

    # –í–æ–∑—Ä–∞—Å—Ç ‚Üí ¬´–º–æ–ª–æ–¥–æ–π¬ª, ¬´–≤ —Ä–∞—Å—Ü–≤–µ—Ç–µ —Å–∏–ª¬ª, ¬´–∑—Ä–µ–ª—ã–π¬ª, ¬´–æ–ø—ã—Ç–Ω—ã–π¬ª
    age_phrase = None
    if isinstance(user_age, int) and user_age > 0:
        if user_age < 25:
            age_phrase = "–º–æ–ª–æ–¥–æ–π"
        elif 25 <= user_age <= 35:
            age_phrase = "–≤ —Ä–∞—Å—Ü–≤–µ—Ç–µ —Å–∏–ª"
        elif 36 <= user_age <= 50:
            age_phrase = "–∑—Ä–µ–ª—ã–π"
        else:
            age_phrase = "–æ–ø—ã—Ç–Ω—ã–π"

    lines: list[str] = [
        "–£—á–∏—Ç—ã–≤–∞–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø—Ä–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, "
        "–Ω–æ –ù–ï —É–ø–æ–º–∏–Ω–∞–π –∏—Ö –ø—Ä—è–º–æ –≤ —Ç–µ–∫—Å—Ç–µ:"
    ]

    if user_name:
        lines.append(f"- –ò–º—è: {user_name}")

    if user_gender:
        lines.append(f"- –ü–æ–ª: {gender_label}")

    if isinstance(user_age, int) and user_age > 0:
        if age_phrase:
            lines.append(f"- –í–æ–∑—Ä–∞—Å—Ç: {user_age} –ª–µ—Ç ({age_phrase})")
        else:
            lines.append(f"- –í–æ–∑—Ä–∞—Å—Ç: {user_age} –ª–µ—Ç")

    lines.append(
        "–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–æ–Ω–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –Ω–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞–π –∏—Ö —è–≤–Ω–æ."
    )

    return "\n".join(lines)


def _get_spread_name(spread_type: str, cards: list[dict]) -> str:
    """–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ö–µ–ª–ø–µ—Ä –¥–ª—è —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞—Å–∫–ª–∞–¥–∞."""
    st = (spread_type or "").lower().strip()

    if st in {"one", "single", "card"} or len(cards) == 1:
        return "–ö–∞—Ä—Ç–∞ –¥–Ω—è"

    if st in {"three", "3"} or len(cards) == 3:
        return "–†–∞—Å–∫–ª–∞–¥ ¬´–ü—Ä–æ—à–ª–æ–µ‚Äì–ù–∞—Å—Ç–æ—è—â–µ–µ‚Äì–ë—É–¥—É—â–µ–µ¬ª"

    # –§–æ–ª–±—ç–∫ –Ω–∞ —Å–ª—É—á–∞–π –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
    return "–¢–∞—Ä–æ-—Ä–∞—Å–∫–ª–∞–¥"


def _is_reversed_flag(card: dict) -> bool:
    """
    –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ—Å—Ç–∏:
    –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∏ is_reversed, –∏ reversed –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π.
    """
    if "is_reversed" in card:
        return bool(card.get("is_reversed"))
    if "reversed" in card:
        return bool(card.get("reversed"))
    return False


def _build_cards_text(spread_type: str, cards: list[dict]) -> str:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ –∫–∞—Ä—Ç–∞–º –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞.

    –ñ—ë—Å—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–∞—Ä—Ç:

    ‚Ä¢ 1 –∫–∞—Ä—Ç–∞ ‚Äî –±–µ–∑ –ø–æ–∑–∏—Ü–∏–π, —Ç–æ–ª—å–∫–æ –∏–º—è + –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è.
    ‚Ä¢ 3 –∫–∞—Ä—Ç—ã ‚Äî —Å—Ç—Ä–æ–≥–æ ¬´–ü—Ä–æ—à–ª–æ–µ / –ù–∞—Å—Ç–æ—è—â–µ–µ / –ë—É–¥—É—â–µ–µ¬ª.
    ‚Ä¢ 4+ –∫–∞—Ä—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫ –±–µ–∑ –ø–æ–∑–∏—Ü–∏–π.
    """
    if not cards:
        return "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ä—Ç–∞–º"

    # 1 –∫–∞—Ä—Ç–∞ ‚Äî –Ω–∏–∫–∞–∫–æ–≥–æ "–ø—Ä–æ—à–ª–æ–µ/–Ω–∞—Å—Ç–æ—è—â–µ–µ/–±—É–¥—É—â–µ–µ"
    if len(cards) == 1:
        card = cards[0]
        name = card.get("name") or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞"
        is_rev = _is_reversed_flag(card)
        orient = "–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è" if is_rev else "–ø—Ä—è–º–∞—è"
        return f"- {name} ({orient})"

    # 3 –∫–∞—Ä—Ç—ã ‚Äî —Å—Ç—Ä–æ–≥–æ –ü/–ù/–ë
    if len(cards) == 3:
        positions = ["–ü—Ä–æ—à–ª–æ–µ", "–ù–∞—Å—Ç–æ—è—â–µ–µ", "–ë—É–¥—É—â–µ–µ"]
        lines: list[str] = []
        for pos, card in zip(positions, cards):
            name = card.get("name") or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞"
            is_rev = _is_reversed_flag(card)
            orient = "–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è" if is_rev else "–ø—Ä—è–º–∞—è"
            lines.append(f"- {pos}: {name} ({orient})")
        return "\n".join(lines)

    # 4+ –∫–∞—Ä—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫ –±–µ–∑ –ø–æ–∑–∏—Ü–∏–π
    lines: list[str] = []
    for card in cards:
        name = card.get("name") or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞"
        is_rev = _is_reversed_flag(card)
        orient = "–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è" if is_rev else "–ø—Ä—è–º–∞—è"
        lines.append(f"- {name} ({orient})")
    return "\n".join(lines)


def build_spread_interpretation_prompt(
    spread_type: str,
    cards: list[dict],
    category: str | None = None,
    question: str | None = None,
    profile_context: str = "",
) -> str:
    """
    –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —Ä–∞—Å–∫–ª–∞–¥–∞
    —Å —É—á—ë—Ç–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —è–≤–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    spread_name = _get_spread_name(spread_type, cards)
    cards_text = _build_cards_text(spread_type, cards)

    category_text = category or "–æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å"

    profile_block = ""
    if profile_context:
        profile_block = profile_context.strip() + "\n\n"

    question_block = ""
    if question:
        q_clean = question.strip()
        if q_clean:
            question_block = f'\n–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{q_clean}"\n'

    # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –õ–õ–ú –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞—Ä—Ç
    if len(cards) == 1:
        extra_hint = (
            "–≠—Ç–æ —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ –æ–¥–Ω—É –∫–∞—Ä—Ç—É. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏ –Ω–µ –¥–µ–ª–∏ "
            "–Ω–∞ –ø—Ä–æ—à–ª–æ–µ/–Ω–∞—Å—Ç–æ—è—â–µ–µ/–±—É–¥—É—â–µ–µ. –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–º—ã—Å–ª–µ —ç—Ç–æ–π –∫–∞—Ä—Ç—ã "
            "–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ–ø—Ä–æ—Å–∞.\n\n"
        )
    elif len(cards) == 3:
        extra_hint = (
            "–≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–∞—Å–∫–ª–∞–¥ –∏–∑ —Ç—Ä—ë—Ö –∫–∞—Ä—Ç: –ø—Ä–æ—à–ª–æ–µ, –Ω–∞—Å—Ç–æ—è—â–µ–µ –∏ –±—É–¥—É—â–µ–µ. "
            "–Ø—Å–Ω–æ —Ä–∞–∑–¥–µ–ª—è–π —ç—Ç–∏ —Ç—Ä–∏ –ø–æ–∑–∏—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏.\n\n"
        )
    else:
        extra_hint = ""

    prompt = f"""
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º.

üö® –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –Ø–ó–´–ö–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
2. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞, –∫—Ä–æ–º–µ –æ–±—â–µ—É–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–º—ë–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö.
3. –ü–∏—à–∏ –∂–∏–≤—ã–º, —á–µ–ª–æ–≤–µ—á–Ω—ã–º, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–º —è–∑—ã–∫–æ–º, –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥, –æ–±—ä—è—Å–Ω—è—é—â–∏–π —Ä–∞—Å–∫–ª–∞–¥ –∫–ª–∏–µ–Ω—Ç—É.
4. –ò–∑–±–µ–≥–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π —Å–º–µ—Ä—Ç–∏, —Ç—è–∂—ë–ª—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –∏ –¥—Ä—É–≥–∏—Ö –ø—É–≥–∞—é—â–∏—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤.
5. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã (JSON, —Å–ø–∏—Å–∫–∏ –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Ç.–ø.).
6. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π HTML-—Ä–∞–∑–º–µ—Ç–∫—É.

{profile_block}–¢–∏–ø —Ä–∞—Å–∫–ª–∞–¥–∞: {spread_name}
–ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤–æ–ø—Ä–æ—Å–∞: {category_text}{question_block}{extra_hint}–ö–∞—Ä—Ç—ã –≤ —Ä–∞—Å–∫–ª–∞–¥–µ:
{cards_text}

–ù–∞—á–Ω–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ:
""".strip()

    return prompt


def build_question_answer_prompt(
    spread_type: str,
    category: str,
    cards_text: str,
    interpretation_text: str,
    question: str,
    profile_context: str = "",
) -> str:
    """
    –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–Ω–æ–º—É —Ä–∞—Å–∫–ª–∞–¥—É.
    """
    spread_name = _get_spread_name(spread_type, [])

    profile_block = ""
    if profile_context:
        profile_block = profile_context.strip() + "\n\n"

    category_text = category or "–æ–±—â–∏–π"
    question_clean = (question or "").strip()
    interpretation_clean = (interpretation_text or "").strip()
    cards_clean = (cards_text or "").strip() or "–Ω–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –∫–∞—Ä—Ç"

    prompt_lines = [
        "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Ä–∞—Å–∫–ª–∞–¥—É.",
        "",
        profile_block.rstrip(),  # –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
        f'–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{question_clean}"',
        "",
        "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å–∫–ª–∞–¥–µ:",
        f"- –¢–∏–ø: {spread_name}",
        f"- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_text}",
        f"- –ö–∞—Ä—Ç—ã: {cards_clean}",
        f"- –ò—Å—Ö–æ–¥–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: {interpretation_clean}",
        "",
        "–û—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ):",
    ]

    prompt = "\n".join(line for line in prompt_lines if line != "" or profile_block)
    return prompt.strip()


__all__ = [
    "BASE_TAROT_SYSTEM_PROMPT",
    "build_profile_context",
    "build_spread_interpretation_prompt",
    "build_question_answer_prompt",
]
