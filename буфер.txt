1) src/tma_api/spreads/sqlite_repository.py
–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º—ã
–í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ __init__ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è _init_schema(), –∫–æ—Ç–æ—Ä–∞—è —á–µ—Ä–µ–∑ CREATE TABLE IF NOT EXISTS —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã tma_spreads –∏ tma_spread_questions —Å—Ç—Ä–æ–≥–æ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ –¢–ó / md. JSON-–∫–æ–ª–æ–¥—É –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.

–ú–∞–ø–ø–µ—Ä—ã —Å—Ç—Ä–æ–∫ –ë–î

_row_to_spread(row) –æ—Ç–¥–∞—ë—Ç dict —Å –∫–ª—é—á–∞–º–∏: id, user_id, spread_type, category, user_question, cards (json.loads(cards_json)), interpretation, created_at.

_row_to_question(row) –º–∞–ø–ø–∏—Ç —Å—Ç—Ä–æ–∫—É tma_spread_questions –≤ dict —Å: id, spread_id, user_id, question, answer, status, created_at.
–ü–æ–¥–∫–ª—é—á—ë–Ω row_factory = sqlite3.Row –≤ _get_connection.

save_spread
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç insert + update:

–ï—Å–ª–∏ data["id"] –µ—Å—Ç—å –∏ > 0 ‚Üí UPDATE tma_spreads ... WHERE id = ?, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ id.

–ò–Ω–∞—á–µ INSERT INTO tma_spreads (...) VALUES (...), —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç cards –≤ cards_json, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç lastrowid.

get_spread
–î–æ—Å—Ç–∞—ë—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –ø–æ id –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ user_id (—ç—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–µ—Ä–≤–∏—Å). –ï—Å–ª–∏ row is None ‚Üí None, –∏–Ω–∞—á–µ ‚Üí _row_to_spread(row).

list_spreads

–°–Ω–∞—á–∞–ª–∞ —Å—á–∏—Ç–∞–µ—Ç total –ø–æ user_id.

–ü–æ—Ç–æ–º –≤—ã–±–æ—Ä–∫–∞ —Å ORDER BY created_at DESC, id DESC LIMIT ? OFFSET ?.

–ö–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –≥–æ–Ω—è–µ—Ç —á–µ—Ä–µ–∑ _row_to_spread, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç (total, items).

save_question
–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ä–∞—Å–∫–ª–∞–¥–∞–º:

–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ id ‚Üí UPDATE tma_spread_questions ... WHERE id = ?.

–ë–µ–∑ id ‚Üí INSERT INTO tma_spread_questions (...) VALUES (...).
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç id (—Å—Ç–∞—Ä—ã–π –∏–ª–∏ –Ω–æ–≤—ã–π).

list_questions
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ spread_id, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π created_at ASC, id ASC, —á–µ—Ä–µ–∑ _row_to_question. –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å –æ–∂–∏–¥–∞–µ–º—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º SpreadRepository –∏ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–æ–π SpreadService.

2) src/user_database.py
–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–î–æ–±–∞–≤–ª–µ–Ω TMA-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π get_connection():

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—É—Ç—å src/data/luna_users.db.

–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ src/data.

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π sqlite3.Connection.

–í–∫–ª—é—á—ë–Ω row_factory = sqlite3.Row –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤–∏–¥–∞ row["id"].

–í–∫–ª—é—á—ë–Ω PRAGMA foreign_keys = ON –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

–°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ UserDatabase –Ω–µ —Ç—Ä–æ–Ω—É—Ç–∞:

–ü–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç DATABASE_URL –∏ —Å–≤–æ–π self.conn.

–ì–ª–æ–±–∞–ª—å–Ω—ã–π user_db = UserDatabase() –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª.

–í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –∏—Å—Ç–æ—Ä–∏—è–º–∏, –≤–æ–ø—Ä–æ—Å–∞–º–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ-—Å—Ç–∞—Ä–æ–º—É.

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TMA:

–¢–µ–ø–µ—Ä—å SQLiteSpreadRepository –∏ TMA API –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

from src.user_database import get_connection
repo = SQLiteSpreadRepository(conn_factory=get_connection)


–≠—Ç–æ –¥–∞—ë—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –¥–æ—Å—Ç—É–ø –∫ SQLite –¥–ª—è TMA, –±–µ–∑ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –±–æ—Ç–∞

3) src/tma_api/spreads/repository.py
–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

Protocol —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω
SpreadRepository —Ä–æ–≤–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¢–ó 23.3:

def save_spread(self, data: dict[str, Any]) -> int: ...
def get_spread(self, spread_id: int) -> dict[str, Any] | None: ...
def list_spreads(self, user_id: int, offset: int, limit: int) -> tuple[int, list[dict[str, Any]]]: ...
def save_question(self, data: dict[str, Any]) -> int: ...
def list_questions(self, spread_id: int) -> list[dict[str, Any]]: ...


–ù–∏–∫–∞–∫–∏—Ö user_id –≤ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞—Ö get_spread / list_questions ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—É–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞.

InMemorySpreadRepository

–ü–æ–¥–æ–≥–Ω–∞–Ω –ø–æ–¥ —ç—Ç–∏ –∂–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã (–æ–Ω–∏ —É–∂–µ —Å–æ–≤–ø–∞–¥–∞–ª–∏, —Ç–∞–∫ —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Å—É—Ç–∏ –Ω–µ—Ç).

–õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ user_id –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ ‚Äî –≤ list_spreads.

list_questions –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ spread_id.

SQLiteSpreadRepository

–î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å —Å –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–º–∏ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞–º–∏ –º–µ—Ç–æ–¥–∞–º Protocol.

–ü–æ–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ —Ç–æ–Ω–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ InMemorySpreadRepository (—Ä–∞–±–æ—á–∞—è –∑–∞–≥–ª—É—à–∫–∞), —á—Ç–æ–±—ã:

—É–∂–µ —Å–µ–π—á–∞—Å –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å SQLiteSpreadRepository –≤ —Å–µ—Ä–≤–∏—Å;

–ø—Ä–∏ —ç—Ç–æ–º –Ω–µ –ø–ª–æ–¥–∏—Ç—å NotImplementedError –≤ —Ä–∞–Ω—Ç–∞–π–º–µ;

–ø–æ–∑–∂–µ –∑–∞–º–µ–Ω–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π _inner –∏ –º–µ—Ç–æ–¥—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É —Å SQLite.

–≠–∫—Å–ø–æ—Ä—Ç

–í __all__ –¥–æ–±–∞–≤–ª–µ–Ω SQLiteSpreadRepository, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å:

from .repository import SpreadRepository, InMemorySpreadRepository, SQLiteSpreadRepository

4) src/tma_api/spreads/service.py
üìù –ö—Ä–∞—Ç–∫–æ, —á—Ç–æ —è –∏–∑–º–µ–Ω–∏–ª –ø–æ –¢–ó 23.4

__init__ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

–°–∏–≥–Ω–∞—Ç—É—Ä–∞:

def __init__(self, repo: SpreadRepository | None = None):


–õ–æ–≥–∏–∫–∞ —Ä–æ–≤–Ω–æ –∫–∞–∫ –≤ –¢–ó:

if repo is not None:
    self._repo = repo
else:
    use_sqlite = os.getenv("TMA_USE_SQLITE", "0") == "1"
    if use_sqlite:
        try:
            from src.user_database import get_connection
            self._repo = SQLiteSpreadRepository(get_connection)
            logger.info("SpreadService: using SQLiteSpreadRepository")
        except Exception:
            logger.exception("Failed to init SQLiteSpreadRepository, falling back to InMemorySpreadRepository")
            self._repo = InMemorySpreadRepository()
    else:
        logger.info("SpreadService: using InMemorySpreadRepository")
        self._repo = InMemorySpreadRepository()


–õ–æ–∫–∞–ª—å–Ω—ã–µ in-memory —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏–∑ service.py —É–±—Ä–∞–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–ª–∞—Å—Å—ã –∏–∑ .repository.

create_auto_spread

–ü–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è record:

record = {
    "user_id": user_id,
    "spread_type": spread_type,
    "category": effective_category,
    "user_question": user_question,
    "cards": cards_payload,
    "interpretation": interpretation,
    "created_at": created_at,
}

spread_id = self._repo.save_spread(record)
record["id"] = spread_id


–í SpreadDetail –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ spread_id / record["id"].

get_spreads

–ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ —Å–µ—Ä–≤–∏—Å–µ:

if limit <= 0:
    limit = 10
page = max(page, 1)
offset = (page - 1) * limit


Repo –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫:

total_items, items_raw = self._repo.list_spreads(
    user_id=user_id,
    offset=offset,
    limit=limit,
)


total_pages —Å—á–∏—Ç–∞–µ–º –ø–æ total_items.

–û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ ‚Äî SpreadListItem, short_preview, category –∏ has_questions ‚Äî –æ—Å—Ç–∞–≤–ª–µ–Ω–∞, —Ç–æ–ª—å–∫–æ has_questions —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ _spread_has_questions(self._repo, s).

get_spread

–ë–æ–ª—å—à–µ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ _SPREADS; —Ç–æ–ª—å–∫–æ:

raw = self._repo.get_spread(spread_id)
if not raw or raw.get("user_id") != user_id:
    raise ValueError("spread_not_found")


–î–∞–ª–µ–µ SpreadDetail —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑:

raw["cards"],

raw["interpretation"],

raw["category"],

raw["user_question"].

add_spread_question

–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–∫–ª–∞–¥–∞:

raw_spread = self._repo.get_spread(spread_id)
if not raw_spread or raw_spread.get("user_id") != user_id:
    raise ValueError("spread_not_found")


–ó–∞–ø–∏—Å—å –≤–æ–ø—Ä–æ—Å–∞:

record = {
    "spread_id": spread_id,
    "user_id": user_id,
    "question": question,
    "answer": None,
    "status": "pending",
    "created_at": created_at,
}

qid = self._repo.save_question(record)
record["id"] = qid


–í–æ–∑–≤—Ä–∞—â–∞–µ–º SpreadQuestionModel(**record).

–û—Ç–≤–µ—Ç AI –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º: —Å—Ç–∞—Ç—É—Å "pending", answer None (–≥–æ—Ç–æ–≤–æ –ø–æ–¥ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π pipeline).

get_spread_questions

–°–Ω–∞—á–∞–ª–∞ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–∞—Å–∫–ª–∞–¥ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

raw_spread = self._repo.get_spread(spread_id)
if not raw_spread or raw_spread.get("user_id") != user_id:
    raise ValueError("spread_not_found")


–î–∞–ª—å—à–µ:

rows = self._repo.list_questions(spread_id)
rows_sorted = sorted(rows, key=lambda r: r.get("created_at") or "")
items = [SpreadQuestionModel(**row) for row in rows_sorted]

